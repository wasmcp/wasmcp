spin_manifest_version = 2

[application]
name = "routing-config"
version = "0.1.0"
description = "MCP server demonstrating path-based and tag-based tool filtering"
authors = ["wasmcp contributors"]

# Trigger configuration for MCP over HTTP
[[trigger.http]]
route = "/..."
component = "routing-config"

# The composed filtered server
[component.routing-config]
source = "mcp-server.wasm"
description = "MCP server with filter middleware demonstrating path and tag filtering"
allowed_outbound_hosts = []
key_value_stores = ["default"]

[component.routing-config.environment]
WASMCP_AUTH_MODE = "oauth"
WASMCP_SESSION_ENABLED = "true"
WASMCP_SESSION_BUCKET = "default"  # KV bucket for session storage
JWT_ISSUER = "wasmcp-local-test"
JWT_AUDIENCE = "http://localhost:3000"
JWT_PUBLIC_KEY = "{{ jwt_public_key }}"

# Define variables that can be set via -e flags
[variables]
jwt_public_key = { default = "" }

# ============================================================================
# Development Configuration
# ============================================================================
# For local testing:
#
#   spin up -e JWT_PUBLIC_KEY="$(cat ~/Library/Application\ Support/wasmcp/jwt-test/public.pem)"
#
# Or use the test script which handles this automatically:
#
#   make test
#
# ============================================================================
# Filter Middleware Configuration
# ============================================================================
# Path-based filtering is configured in routing.toml (embedded in component)
#
# Tag-based filtering uses environment variables:
#   TOOL_CATEGORY=math,productivity  # Filter by category tag
#   TOOL_LEVEL=foundational          # Filter by tool-level tag
#
# Example with tag filtering:
#   spin up -e JWT_PUBLIC_KEY="..." -e TOOL_CATEGORY=math
#
# ============================================================================
# Filter Patterns Demonstrated
# ============================================================================
# 1. Path-Based Filtering (from routing.toml):
#    /mcp/math        → calculator-rs tools only (except square_root blacklisted)
#    /mcp/math/addition → only 'add' tool (hierarchical override)
#    /mcp/calc        → add, subtract, factorial only
#    /mcp/todo        → todo-list-auth tools only
#    /mcp             → all tools (no filtering)
#
# 2. Tag-Based Filtering (from env vars):
#    TOOL_CATEGORY=math → only tools with category:math tag
#    TOOL_LEVEL=foundational → only foundational-level tools
#    (Multiple filters use AND logic - tool must match all)
#
