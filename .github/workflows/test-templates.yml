name: Test Templates

# Only run template tests when CLI code changes
on:
  pull_request:
    branches: [ main ]
    paths:
      - 'cli/**'
  push:
    branches: [ main ]
    paths:
      - 'cli/**'

# Cancel in-progress runs when a new commit is pushed to the same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  RUST_VERSION: "1.89"

jobs:
  build-cli:
    name: Build CLI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key: cli
          workspaces: cli

      - name: Build CLI
        run: cd cli && cargo build --release --target x86_64-unknown-linux-gnu
        env:
          CARGO_BUILD_JOBS: 4

      - name: Upload CLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: wasmcp-cli-linux
          path: cli/target/x86_64-unknown-linux-gnu/release/wasmcp

  test-templates:
    name: Test templates (${{ matrix.language }})
    runs-on: ubuntu-latest
    needs: build-cli
    strategy:
      matrix:
        language: [python, rust, typescript]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Download CLI artifact
        uses: actions/download-artifact@v4
        with:
          name: wasmcp-cli-linux
          path: /tmp/wasmcp-bin

      - name: Install wasmcp CLI
        run: |
          chmod +x /tmp/wasmcp-bin/wasmcp
          sudo mv /tmp/wasmcp-bin/wasmcp /usr/local/bin/

      - name: Install wasmtime
        run: |
          curl -fsSL https://github.com/bytecodealliance/wasmtime/releases/download/v29.0.0/wasmtime-v29.0.0-x86_64-linux.tar.xz | tar -xJ
          sudo mv wasmtime-v29.0.0-x86_64-linux/wasmtime /usr/local/bin/

      - name: Install language tooling (Rust)
        if: matrix.language == 'rust'
        run: |
          rustup update stable
          rustup target add wasm32-wasip2

      - name: Install language tooling (Python)
        if: matrix.language == 'python'
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install componentize-py

      - name: Install language tooling (TypeScript)
        if: matrix.language == 'typescript'
        run: |
          # Node.js and npm already installed in Setup Node.js step
          npm install -g @bytecodealliance/jco

      - name: Create test project from template
        run: |
          wasmcp new ci-test-${{ matrix.language }} --language ${{ matrix.language }}

      - name: Build component
        run: cd ci-test-${{ matrix.language }} && make

      - name: Compose HTTP server
        run: |
          cd ci-test-${{ matrix.language }}
          # Determine component path based on language
          if [ "${{ matrix.language }}" = "rust" ]; then
            COMPONENT="target/wasm32-wasip2/release/ci_test_${{ matrix.language }}.wasm"
          elif [ "${{ matrix.language }}" = "typescript" ]; then
            COMPONENT="target/ci-test-typescript.wasm"
          else
            # Python keeps hyphens in component names
            COMPONENT="target/ci-test-${{ matrix.language }}.wasm"
          fi
          wasmcp compose $COMPONENT -o mcp-server.wasm

      - name: Compose stdio server
        run: |
          cd ci-test-${{ matrix.language }}
          # Determine component path based on language
          if [ "${{ matrix.language }}" = "rust" ]; then
            COMPONENT="target/wasm32-wasip2/release/ci_test_${{ matrix.language }}.wasm"
          elif [ "${{ matrix.language }}" = "typescript" ]; then
            COMPONENT="target/ci-test-typescript.wasm"
          else
            # Python keeps hyphens in component names
            COMPONENT="target/ci-test-${{ matrix.language }}.wasm"
          fi
          wasmcp compose $COMPONENT --transport stdio -o mcp-server-stdio.wasm

      - name: Start HTTP server (background)
        run: |
          cd ci-test-${{ matrix.language }}
          wasmtime serve -Scommon mcp-server.wasm &
          echo $! > /tmp/server.pid
          sleep 2

      - name: Test HTTP server with MCP Inspector
        run: |
          # Test tools/list
          tools_list=$(npx @modelcontextprotocol/inspector@0.16.8 --cli http://localhost:8080/mcp \
            --method tools/list)

          # Verify tools are present (different per language)
          if [ "${{ matrix.language }}" = "rust" ]; then
            echo "$tools_list" | grep -q "sum"
            echo "$tools_list" | grep -q "sub"
          elif [ "${{ matrix.language }}" = "typescript" ]; then
            echo "$tools_list" | grep -q "example-tool"
          else
            echo "$tools_list" | grep -q "reverse"
            echo "$tools_list" | grep -q "uppercase"
          fi

          # Test tools/call
          if [ "${{ matrix.language }}" = "rust" ]; then
            response=$(npx @modelcontextprotocol/inspector@0.16.8 --cli http://localhost:8080/mcp \
              --method tools/call \
              --tool-name sum \
              --tool-arg a=10 --tool-arg b=32)
            echo "$response" | grep -q "42"
          elif [ "${{ matrix.language }}" = "typescript" ]; then
            response=$(npx @modelcontextprotocol/inspector@0.16.8 --cli http://localhost:8080/mcp \
              --method tools/call \
              --tool-name example-tool \
              --tool-arg input="test")
            echo "$response" | grep -q "Received: test"
          else
            response=$(npx @modelcontextprotocol/inspector@0.16.8 --cli http://localhost:8080/mcp \
              --method tools/call \
              --tool-name reverse \
              --tool-arg text="hello")
            echo "$response" | grep -q "olleh"
          fi

      - name: Stop HTTP server
        if: always()
        run: |
          if [ -f /tmp/server.pid ]; then
            kill $(cat /tmp/server.pid) || true
          fi

      - name: Test stdio server with MCP Inspector
        run: |
          cd ci-test-${{ matrix.language }}

          # Test tools/list
          tools_list=$(npx @modelcontextprotocol/inspector@0.16.8 wasmtime run -Shttp mcp-server-stdio.wasm \
            --cli --transport stdio --method tools/list)

          # Verify tools are present (different per language)
          if [ "${{ matrix.language }}" = "rust" ]; then
            echo "$tools_list" | grep -q "sum"
            echo "$tools_list" | grep -q "sub"
          elif [ "${{ matrix.language }}" = "typescript" ]; then
            echo "$tools_list" | grep -q "example-tool"
          else
            echo "$tools_list" | grep -q "reverse"
            echo "$tools_list" | grep -q "uppercase"
          fi

          # Test tools/call
          if [ "${{ matrix.language }}" = "rust" ]; then
            response=$(npx @modelcontextprotocol/inspector@0.16.8 wasmtime run -Shttp mcp-server-stdio.wasm \
              --cli --transport stdio --method tools/call --tool-name sum --tool-arg a=10 --tool-arg b=32)
            echo "$response" | grep -q "42"
          elif [ "${{ matrix.language }}" = "typescript" ]; then
            response=$(npx @modelcontextprotocol/inspector@0.16.8 wasmtime run -Shttp mcp-server-stdio.wasm \
              --cli --transport stdio --method tools/call --tool-name example-tool --tool-arg input="test")
            echo "$response" | grep -q "Received: test"
          else
            response=$(npx @modelcontextprotocol/inspector@0.16.8 wasmtime run -Shttp mcp-server-stdio.wasm \
              --cli --transport stdio --method tools/call --tool-name reverse --tool-arg text="hello")
            echo "$response" | grep -q "olleh"
          fi
